#R_code_exam_Yellowstone_burn_recovery

#Nell'estate del 1988, i fulmini e gli incendi provocati dall'uomo consumarono vaste aree del Parco Nazionale di Yellowstone, soprattutto la parte occidentale, minacciando le strutture storiche intorno al bacino del geyser Old Faithful.
#La primavera era stata umida, e l'erba era abbondante. L'estate era calda e secca. Quando gli inevitabili temporali senza pioggia attraversarono il parco, i fulmini incendiarono la vegetazione secca. Entro la fine dell'estate, 50 incendi (alcuni iniziati da persone) avevano bruciato 793.000 dei 2.221.800 acri del parco.

#Queste quattro immagini(1987,1988,1989,2008) tracciano un incendio nella parte occidentale di Yellowstone e il graduale recupero del paesaggio per un periodo di vent'anni.
I#l satellite Landsat-5 ha acquisito questa serie di immagini tra il 1987 e il 2008. 
#Le immagini sono state realizzate con una combinazione di luce visibile e infrarossa (verde, infrarossi a onde corte (SWIR) e vicino all'infrarosso(NIR)) per evidenziare l'area bruciata e i cambiamenti nella vegetazione.

#L'immagine del 1987 mostra il parco com'era stato per molti anni. Fitti alberi di pino alti e diritti ricoprivano l'altopiano vulcanico. La vecchia foresta è verde scuro, la foresta estiva è spezzata da verde brillante, prati erbosi ripari e boscaglia occasionale e erba di pianura, verde chiaro e marrone chiaro. 
#I campi di geyser ricchi di minerali sono blu pallido e bianco, e i laghi sono blu scuro. Sotto la vegetazione verde, una tinta rosata emerge in luoghi, che possono indicare vecchie cicatrici bruciate o semplicemente estate erbe dormienti e piante.

#L'incendio stava ancora bruciando quando l'immagine del 1988 è stata acquisita il 23 agosto. I fuochi brillano rosa brillante, e una pallida coltre di fumo incombe sulla scena. Se l'immagine fosse stata fatta con luce visibile, per assomigliare a ciò che una persona vedrebbe dall'aria, il fumo sarebbe più denso di quanto lo sia in questa immagine infrarossa. Il fumo è blu nella luce infrarossa.

#1989 Solo un anno dopo, alberi carbonizzati e erbe sono stati sostituiti da foreste e prati. La terra appena bruciata è di colore rosso scuro. La terra appena bruciata è di colore rosso scuro. Nell'immagine del 1989, viene rivelata la piena estensione dell'incendio. La terra bruciata circonda l'Old Faithful e si estende in tutta la parte occidentale di Yellowstone. Questa vista satellitare rivela che il fuoco non ha bruciato tutto in una fascia distruttiva. L'area bruciata è irregolare, e la gravità della bruciatura varia da luogo a luogo. Le aree rosse più scure sono gravi ustioni, e le aree rosse più chiare sono meno gravi.

Negli anni che seguono, la cicatrice si affievolisce progressivamente. A terra, erbe e fiori selvatici spuntano dalle ceneri. Nel corso del tempo, piccoli alberi di pino ha messo radici e ha cominciato a crescere. I nuovi alberi crescono più rapidamente (fotosintetizzare ad un tasso più veloce) rispetto a vecchi, foreste mature. Poiché usano e riflettono la luce del sole in modo diverso rispetto alle foreste più antiche, i nuovi alberi sono di colore più chiaro in queste immagini. 

#2008 Vent'anni dopo l'incendio, la cicatrice da bruciatura era ancora evidente, anche se sbiadita fino ad un'abbronzatura pallida e rosata. A questo punto, nuovi pini avevano messo radici, e la foresta aveva iniziato a tornare. I nuovi alberi crescono più rapidamente (fotosintesi ad un tasso più veloce) rispetto alle foreste più vecchie e mature. Poiché usano e riflettono la luce del sole in modo diverso rispetto alle foreste più vecchie, i nuovi alberi sono di colore più chiaro nell'immagine del 2008. Dita di nuova foresta sono più evidente intrusione nella stretta striscia di terra bruciata sul bordo destro dell'immagine. Le foreste stanno probabilmente tornando altrove ma i piccoli alberi non producono una tettoia abbastanza densa da apparire bene nell'immagine. Alcuni degli altri cambiamenti osservati di anno in anno sono differenze stagionali; le immagini vanno da luglio a ottobre.


#In questo codice sul recupero delle zone colpite dall'incendio nel parco di Yellowstone nel 1988:
#-confronteremo le varie immagini scaricate dal sito NASA Earth Observatory https://earthobservatory.nasa.gov/world-of-change/Yellowstone e salvate nella cartella "yellowstone" nel disco locale C in una Times series 1987-2018,
#-verrà poi calcolato variabilità multitemporale e NDVI  #library(raster) #library(rasterVis) per levelplot
#-verrà operata una CLASSIFICAZIONE delle immagini #library(RStoolbox)
#-valutazione della LAND COVER #library (ggplot2) e (gridExtra) per il plottaggio 
#-variabilità spaziale: calcolata con eterogeneità dell'area utilizzando la tecnica della MOVING WINDOW
#firme spettrali

install.packages("raster") #scarica e installa dal CRAN o da files locali
library(raster) #richiamo questa libreria che carica\allega i files su R
library(rgdal) #importa file raster e TIF e firme spettrali
library(rasterVis)
library(RStoolbox)
library(ggplot2)
library(gridExtra)
setwd ("C:/lab/yellowstone/") #Windows  #setto la R Working Directory per spiegare ad R da che cartella andare a caricare il nostro dataset di immagini

#1. Times series 1987-2018
#importo le immagini usando la funzione "brick" all'interno del pacchetto raster che crear un oggetto rasterbrick (oggetto raster multi-layer)

Ys_1987beforefire<-brick("Yellowstone_19870805.jpg")
Ys_1988fire<-brick("Yellowstone_19880823.jpg")
Ys_1989afterfire<-brick("Yellowstone_19890802.jpg")
Ys_1993<-brick("Yellowstone_19930922.jpg")
Ys_1996<-brick("Yellowstone_19960712.jpg")
Ys_1998<-brick("Yellowstone_19980718.jpg")
Ys_2008<-brick("Yellowstone_20080915.jpg")
Ys_2018<-brick("yellowstone_20180222.jpg")

par(mfrow=c(2,4))  #funzione generica che permette il settaggio dei parametri grafici creando un multiframe, in questo caso plottiamo le immagini in RGB(schema red,green,blue)per visualizzare un oggetto raster multi-layer

#le immagini scaricate e processate dal sito Earth Observatory NASA avevano già le bande sono state realizzate con una combinazione di luce visibile e infrarossa (verde, infrarossi a onde corte(SWIR) e vicino all'infrarosso(NIR)) per evidenziare l'area bruciata e i cambiamenti nella vegetazione.
#se l'immagine fosse stata fatta con luce visibile, il fumo sarebbe così denso nell'immagine del 1988 denso da non permettere di vedere quasi nulla. Nell'immagine in infrarosso il fumo diventa invece una patina blu.

plotRGB(Ys_1987beforefire,1, 2, 3, stretch="Lin")  #l'argomento "stretch"(lin o hist) fa si che la riflettanza delle singole bande venga "stirata" in modo che non ci siano schiacciamenti di colori e vengano tutti mostrati.
plotRGB(Ys_1988fire,1, 2, 3, stretch="Lin")
plotRGB(Ys_1989afterfire,1, 2, 3, stretch="Lin")
plotRGB(Ys_1993,1, 2, 3, stretch="Lin")
plotRGB(Ys_1996,1, 2, 3, stretch="Lin")
plotRGB(Ys_1998,1, 2, 3, stretch="Lin")
plotRGB(Ys_2008,1, 2, 3, stretch="Lin")
plotRGB(Ys_2018,1, 2, 3, stretch="Lin")

# colorRampPalette estende la palette dei colori, i numeri che vediamo a lato dell'immagine sono i valori di riflettanza e ad ogni valore è stato associato un colore
cl <- colorRampPalette(c('dark red','red','orange','yellow'))(100)  #c creazione di un vettore o array(argomento) che racchiude i nuovi colori scelti (elementi)
plot(Ys_1988fire, col=cl)

#Utilizzando la funzione "raster" carico le singole immagini e le plotto
Ys_1987beforefireR <- raster("Yellowstone_19870805.jpg") 
cts <- colorRampPalette(c("blue","dark green","light green","orange","white")) (100)
plot(Ys_1987beforefire, col=cts)
Ys_1988fireR<-raster("Yellowstone_19880823.jpg")
plot(Ys_1988fire,col=cts)
Ys_1989afterfireR<-raster("Yellowstone_19890802.jpg")
plot(Ys_1989afterfire,col=cts)
Ys_1993R<-raster("Yellowstone_19930922.jpg")
plot(Ys_1993,col=cts)
Ys_1996R<-raster("Yellowstone_19960712.jpg")
plot(Ys_1996,col=cts)
Ys_1998R<-raster("Yellowstone_19980718.jpg")
plot(Ys_1998,col=cts)
Ys_2008R<-raster("Yellowstone_20080915.jpg")
plot(Ys_2008,col=cts)
Ys_2018R<-raster("Yellowstone_20180222.jpg")
plot(Ys_2018,col=cts)

par(mfrow=c(2,4))
plot(Ys_1987beforefireR, col=cts)
plot(Ys_1988fire,col=cts)
plot(Ys_1989afterfireR,col=cts)
plot(Ys_1993R,col=cts)
plot(Ys_1996R,col=cts)
plot(Ys_1998R,col=cts)
plot(Ys_2008R,col=cts)
plot(Ys_2018R,col=cts)

#Creiamo una lista con la funzione "list.files" e utilizziamo un "pattern" che accomuna tutti i files, in questo caso "Yellowstone_" Per importare tutte queste immagini insieme usiamo la funzione "lapply" applicabile ad una lista di file o un vettore
rlist <- list.files(pattern="Yellowstone_")
rlist

import <- lapply(rlist,raster) #alla funzione "lapply" viene applicata la funzione "raster"
import

timesYs<-stack(import) #la funzione "stack" crea un unico file partendo da una lista o un dataframe a cui associamo un nome
levelplot(timesYs) 

#Possiamo anche applicare la funzione "levelplot" considerando ogni singolo file interno a "timesYs"
levelplot(timesYs$Ys_1987beforefireR)

cl <- colorRampPalette(c("blue","light blue","pink","red"))(100)
levelplot(timesYs,col.regions=cl,main="Yellostone Park's burn recovery",names.attr=c("1987","1988", "1989", "1993","1996","1998","2008","2018"))

#2. Unsupervised classification
#in questo processo vengono accorpati pixel di un'immagine con valori simili a rappresentare una CLASSE. Ogni classe ha quindi dei pixel che corrispondono ad un determinato valore di riflettanza.

set.seed(42)  #questa funzione fa in modo che vengano utilizzate sempre le stesse repliche per il modello e che i colori rimangano gli stessi.
class1987<- unsuperClass(Ys_1987beforefire, nClasses=5)
cl <- colorRampPalette(c('black','purple','red','orange','yellow'))(100)
plot(class1987$map,col=cl)
class1988<- unsuperClass(Ys_1988fire, nClasses=5)
plot(class1988$map,col=cl)
class1989<- unsuperClass(Ys_1989afterfire, nClasses=5)
plot(class1989$map,col=cl)
class2018<- unsuperClass(Ys_2018, nClasses=5)
plot(class2018$map,col=cl)

set.seed(1)
par(mfrow=c(2,2))
plot(class1987$map,col=cl)
plot(class1988$map,col=cl)
plot(class1989$map,col=cl)
plot(class2018$map,col=cl)

#3. NDVI (indice di vegetazione normalizzato)
#(NIR-RED)/(NIR+RED) #il range dell'NDVI è [-1 , 1]
#in questo modo è possibile riconoscere la presenza di vegetazione sana e quella non sana


#time 1
clndvi <- colorRampPalette(c('darkblue','yellow','red','black'))(100)
ndvi1 <- (Ys_1989afterfire$Yellowstone_19890802.1-Ys_1989afterfire$Yellowstone_19890802.2) / (Ys_1989afterfire$Yellowstone_19890802.1+Ys_1989afterfire$Yellowstone_19890802.2) 
plot(ndvi1, col=clndvi, main="NDVI time 1")

#time 2
ndvi2 <- (Ys_2018$yellowstone_20180222.1-Ys_2018$yellowstone_20180222.2) / (Ys_2018$yellowstone_20180222.1+Ys_2018$yellowstone_20180222.2)
plot(ndvi2, col=clndvi, main="NDVI time 2")

par(mfrow=c(1,2))
plot(ndvi1, col=clndvi)
plot(ndvi2, col=clndvi)

difndvi<-ndvi1-ndvi2 ##è stata effettuata la differenza tra gli NDVI per valutare se ci sia stato un aumento dell'indice o una diminuzione a causa degli incendi
plot(difndvi,col=clndvi, main="NDVI time1-time2") #o senza la colorramppalette

#Indici spettrali
si1 <-spectralIndices(Ys_1989afterfire, green=3, red=2, nir=1)
plot(vi1, col=cl)

si2 <-spectralIndices(Ys_2018, green=3, red=2, nir=1)
plot(vi2, col=cl)

#5. Land cover
#per plottare in modo migliore le immagini richiamo la library ggplot2 e gridExtra

Ys_1987beforefire<-brick("Yellowstone_19870805.jpg")
Ys_1988fire<-brick("Yellowstone_19880823.jpg")
Ys_1989afterfire<-brick("Yellowstone_19890802.jpg")
Ys_2018<-brick("yellowstone_20180222.jpg")

plotRGB(Ys_1987beforefire,1, 2, 3, stretch="Lin")
plotRGB(Ys_1988fire,1, 2, 3, stretch="Lin")
plotRGB(Ys_1989afterfire,1, 2, 3, stretch="Lin")
plotRGB(Ys_2018,1, 2, 3, stretch="Lin")

p1<-ggRGB(Ys_1987beforefire,1, 2, 3, stretch="Lin") #con questa funzione vengono visualizzate anche le coordinate spaziali del nostro oggetto(conta dei pixel sulla x e sulla y, non è un vero S.R.!)
p2<-ggRGB(Ys_1988fire,1, 2, 3, stretch="Lin")
p3<-ggRGB(Ys_1989afterfire,1, 2, 3, stretch="Lin")
p4<-ggRGB(Ys_2018,1, 2, 3, stretch="Lin")

#per unire i plot generati in questo caso utiliazziamo la funzione "grid.arrange" dalla library gridExtra. Questa funzione compone il nostro multiframe unendo varie parti in un grafico.

grid.arrange(p1, p2, p3, p4, nrow = 2)

#ora classifichiamo le immagini in 2 CLASSI
1a CLASSE = prateria (bianco)
2a CLASSE = nuvole/parte incencendiata (giallo)
3a CLASSE = foresta (verde)

#set.seed() would allow you to attain the same results
Ys1c <- unsuperClass(Ys_1987beforefire, nClasses=3)
Ys1c
plot(Ys1c$map)

Ys2c <- unsuperClass(Ys_1989afterfire, nClasses=3)
plot(Ys2c$map)

#Quanta parte di foresta è andata persa durante l'incendio del 1988? Andiamo a calcolare la frequenza dei pixel di una certa classe
#frequencies
freq(Ys1c$map)
     value   count
[1,]     1 4377087
[2,]     2  681566
[3,]     3 5660423


#calcoliamo la proporzione di pixel e sommiamo i valori
s1<-4377087+681566+5660423
s1
[1] 10719076

prop1<- freq(Ys1c$map)/s1
            value     count
[1,] 9.329162e-08 0.4083456   #prop. 40%    #40.83
[2,] 1.865832e-07 0.0635844   #prop. 0.06%  #06.35
[3,] 2.798749e-07 0.5280701   #prop. 52%    #52.80

s2<- 10719076
prop2<- freq(Ys2c$map)/s2
            value     count
[1,] 9.329162e-08 0.4371661   #43.71
[2,] 1.865832e-07 0.2003741   #20.03
[3,] 2.798749e-07 0.3624598   #36.24

#build a dataframe
cover<- c("prateria", "parte incendiata", "foresta")
percent_1987<- c(40.83,06.35,52.80)
percent_1989<- c(43.71,20.03,36.24)
          
percentages<- data.frame (cover, percent_1987, percent_1989)
percentages  
       cover percent_1987 percent_1989
1         prateria        40.83        43.71
2 parte incendiata         6.35        20.03
3          foresta        52.80        36.24

#Usando ggplot2 generiamo un dataframe
cover1<-ggplot(percentages, aes(x=cover, y=percent_1987, color=cover)) + geom_bar(stat="identity", fill="white")   
cover2<-ggplot(percentages, aes(x=cover, y=percent_1989, color=cover)) + geom_bar(stat="identity", fill="white")   
          
grid.arrange(cover1, cover2, nrow = 1) # this needs griExtra     

#6. Moving window
Ys_2018<-brick("yellowstone_20180222.jpg")
plotRGB(Ys_2018,1, 2, 3, stretch="Lin")
clndvi <- colorRampPalette(c('darkblue','yellow','red','black'))(100)

ndvi2 <- (Ys_2018$yellowstone_20180222.1-Ys_2018$yellowstone_20180222.2) / (Ys_2018$yellowstone_20180222.1+Ys_2018$yellowstone_20180222.2)
plot(ndvi2, col=clndvi, main="NDVI time 2")


#calcolo la variabilità di questa immagine con la funzione focal. La moving window, in questo caso, è una finestra mobile di 3x3 pixel che si muove nei primi 9 pixel dell'immagine e così via.
#Il pixel centrale raccoglie la dev.standard dei 9 pixel. Alla fine otterrò una nuova mappa con pixel colorati diversamente a seconda della dev.standard calcolata in una certa finestra(più la finestra è grande più mi aspetto una certa variabilità).
ndvi2_focal <- focal(ndvi2, w=matrix(1/9,nrow=3,ncol=3), fun=sd)
plot(ndvi2_focal)
clsd <- colorRampPalette(c('blue','green','pink','magenta','orange','brown','red','yellow'))(100)
plot(ndvi2_focal, col=clsd) #il blu dà una copertura omogenea di quelle che sono le rocce e le bruciature degli incendi. In blu anche i laghi. La dev. standard aumenta, quindi diventa più verde nelle zone di confine. Veg. e roccia nuda hanno una diversità più alta a livello spettrale, poi ridiminuisce nelle zone di prateria d'alta quota
 
#mean ndvi with focal
ndvimean <- focal(ndvi2, w=matrix(1/9, nrow=3, ncol=3), fun=mean)
clsd <- colorRampPalette(c('blue','green','pink','magenta','orange','brown','red','yellow'))(100) # 
plot(ndvimean, col=clsd) #valori molto alti nelle praterie d'alta quota, boschi latifoglie e arbusti. Valori più alti per la roccia nuda.

#PCA #la moving window passa sulla PC1 fino a creare una mappa di dev.standard derivante dalla 1a componente principale. Prendendo un sistema multibande ne calcoliamo una PCA e utilizziamo solo la 1a componente principale
Ys_2018_pca<- rasterPCA(Ys_2018)
plot(Ys_2018_pca$map) #la prima componente principale è quella che mantiene l'info originale, man mano che passiamo alle altre bande l'info si perde.

summary(Ys_2018_pca$model)
#the first PC contains  0.8228578  of the original information (proporzione della varianza che spiega quanta variabilità iniziale è presente nelle singole bande).
#Importance of components:
                           Comp.1     Comp.2     Comp.3
Standard deviation     50.3337498 22.1948987 7.26548308
Proportion of Variance  0.8228578  0.1599973 0.01714491
Cumulative Proportion   0.8228578  0.9828551 1.00000000

pc1 <- Ys_2018_pca$map$PC1
plot(pc1)


# https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html
# The package contains eight color scales: “viridis”, the primary choice, and five alternatives with similar properties - “magma”, “plasma”, “inferno”, “civids”, “mako”, and “rocket” -, and a rainbow color map - “turbo”.

#proviamo a plottare i nostri dati con ggplot
p1 <- ggplot() + geom_raster(pc1, mapping = aes(x = x, y = y, fill=PC1)) + scale_fill_viridis()  +ggtitle("Standard deviation of PC1 by viridis colour scale")
 
p2 <- ggplot() +geom_raster(pc1, mapping = aes(x = x, y = y, fill=PC1)) +scale_fill_viridis(option = "magma")  +ggtitle("Standard deviation of PC1 by magma colour scale")

p3 <- ggplot() +geom_raster(pc1, mapping = aes(x = x, y = y, fill=PC1)) +scale_fill_viridis(option = "turbo")  +ggtitle("Standard deviation of PC1 by turbo colour scale")

grid.arrange(p1, p2, p3, nrow = 1)  #questo è il metodo migliore per individuare a livello geografico qualsiasi tipo di discontinuità, a livello ecologico gli ecotoni(passaggio da un paesaggio all'altro)

#7. Firme spettrali
#Le firme spettrali del pixel di una pianta ci permettono di distinguere piante diverse che riflettono la luce in modo diverso. Vediamo se nelle firme spettrali effettivamente ciò che vediamo in termini di colori corrisponde ad una variazione di riflettanza.

Ys_1987beforefire<-brick("Yellowstone_19870805.jpg")
plotRGB(Ys_1987beforefire,1, 2, 3, stretch="Lin")
click(Ys_1987beforefire, id=T, xy=T, cell=T, type="p", pch=16, col="magenta")
#x      y    cell Yellowstone_19870805.1 Yellowstone_19870805.2
1 304.5 2300.5 3185907                    117                    205
  Yellowstone_19870805.3
1                    101
       x      y    cell Yellowstone_19870805.1 Yellowstone_19870805.2
1 1572.5 1524.5 5727799                    102                    111
  Yellowstone_19870805.3
1                     66

       x     y    cell Yellowstone_19870805.1 Yellowstone_19870805.2
1 1464.5 647.5 8598989                    172                    193
  Yellowstone_19870805.3
1                    124
       x      y    cell Yellowstone_19870805.1 Yellowstone_19870805.2
1 1291.5 2236.5 3396430                     95                    111
  Yellowstone_19870805.3
1                     66
       x     y    cell Yellowstone_19870805.1 Yellowstone_19870805.2
1 3020.5 839.5 7971937                     76                    106
  Yellowstone_19870805.3
1                     72

click(Ys_1987beforefire, id=T, xy=T, cell=T, type="p", pch=16, col="green")
 x      y    cell Yellowstone_19870805.1 Yellowstone_19870805.2
1 1662.5 1505.5 5790095                     73                    119
  Yellowstone_19870805.3
1                     57


#Define colors of the dataset:
band<- c(1,2,3)
forest <- c(73,119,57)
grassland <- c(117,205,101)  #i dati sono diversi a seconda dei risultati del click

#Create the dataframe
spectrals <- data.frame(band,forest,grassland)

#Plot the spectral signatures
ggplot(spectrals,aes(x=band)) +geom_line(aes(y=forest), color="dark green")+geom_line(aes(y=grassland), color="light green") 
labs(x="band", y="reflectance")

#......................................
#Multitemporal
defor1 <- brick("defor1.jpg")
plotRGB(defor1, r=1, g=2, b=3, stretch="lin")

#spectral signatures defor1
click(defor1, id=T, xy=T, cell=T, type="p", pch=16, cex=4, col="yellow")

#time t2
plotRGB(defor2, r=1, g=2, b=3, stretch="lin")
click(defor2, id=T, xy=T, cell=T, type="p", pch=16, col="yellow")

# define the columns of the dataset:
band <- c(1,2,3)
time1 <- c(223,11,33)
time2 <- c(197,163,151)
 
spectralst <- data.frame(band, time1, time2)

# plot the sepctral signatures
ggplot(spectrals, aes(x=band)) +
 geom_line(aes(y=time1), color="red") +
 geom_line(aes(y=time2), color="gray") +
 labs(x="band",y="reflectance")
    

# define the columns of the dataset:
band <- c(1,2,3)
time1 <- c(223,11,33)
time1p2 <- c(218,16,38)
time2 <- c(197,163,151)
time2p2 <- c(149,157,133)


spectralst <- data.frame(band, time1, time2, time1p2, time2p2)


# plot the sepctral signatures
ggplot(spectralst, aes(x=band)) +
 geom_line(aes(y=time1), color="red") +
 geom_line(aes(y=time1p2), color="red") +
 geom_line(aes(y=time2), color="gray") +
 geom_line(aes(y=time2p2), color="gray") +
 labs(x="band",y="reflectance")
